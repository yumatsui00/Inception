# Inception

## Docker について
### Docker のメリット
Docker とは、簡単に言うと、アプリケーションと、その依存関係を分離されたコンテナにパッケージすることができるツールです。
- 家で作ったプログラムが、学校のPCでは実行できなかった、、、
- githubからとってきた誰かのプログラムを実行しようとしたら、不足している依存関係があった、、、
- ファイルのバージョンが、自分のOSと互換性がなかった、、、

といった問題を解決できる。仮想環境で解決できる問題ではあるが、Dockerを使うことで
1. 各コンテナを、保存できるイメージ形式でモデル化できる
2. コンテナイメージにより、開発環境と本番環境の一貫性を保てる
3. OSのカーネル共有をするため、仮想マシンに比べ軽量で、起動時間も短い
4. [DockerHub](https://hub.docker.com/) から、いろいろなコンテナイメージを共有できる

といった利点がある。例えば、Webサイトを運営するときに、[NGINX](https://nginx.org/en/)(Webサーバーソフトの一つ)をインストールする必要があるとします。通常通りにインストールするには、適切なOSや依存関係が必要となる。
しかし、NGINXのドッカーイメージはNGINXによって[DockerHub](https://hub.docker.com/)に公開されており、Dockerコンテナを用いてこれをインストールすればそれらの問題を解決できる。
NGINXイメージ例
```
FROM		alpine:3.12

RUN			apk update && apk upgrade && apk add	\
			openssl			\
			nginx			\
			curl			\
			vim				\
			sudo

RUN			rm -f /etc/nginx/nginx.conf

COPY		./config/nginx.conf /etc/nginx/nginx.conf
COPY		scripts/setup_nginx.sh /setup_nginx.sh

RUN			chmod -R +x /setup_nginx.sh

EXPOSE		443

ENTRYPOINT	["sh", "setup_nginx.sh"]
```

このファイルをDockerfileとよび、ドッカーイメージのメインファイルです。

## Dockerfileのキーワード
### FROM
```
FROM <イメージ名>[:<タグ>]
```
- イメージ名：どのOSやベースイメージに基づいて、Dockerイメージが構築されているかを示す。
- タグ：イメージ名のバージョンやバリエーションを示す

例
```
Debian
FROM debian:buster
Linux
FROM alpine:x:xx
Ubunts
FROM ubuntu:20.04
```


### RUN
```
RUN <コマンド>
```

RUN命令は、新しいレイヤーを作成し、指定されたコマンドを実行するために使用される。コマンド実行により、
- 必要なソフトウェアや依存関係のインストール
- システムのセットアップ
- 環境設定
- 不要なファイルの消去やキャッシュの削除
といった、ドッカーイメージ構築に必要なすべての準備を行う。また、RUN命令にはシェル形式とExec形式の２種類が存在し、
```
シェル形式
RUN apt-get update && apt-get install -y curl
Exec形式
RUN ["apt-get", "update"]
RUN ["apt-get", "install", "-y", "curl"]
```
以上のような違いがある。


### COPY
```
COPY <ソース> <コピー先>
最初に、MariaDBを起動し、起動が完了するのを５秒待つ。


Dockerfile内で、ホストマシンからコンテナイメージ内にファイルやディレクトリをコピーするために使用される。
RUNコマンド内でコピーを行うことも可能だが、COPY命令を行うことで、可読性の向上、キャッシュの適切な利用によるビルド時間の短縮、無駄なレイヤーを作成しない効率的なイメージの作成といった観点から、COPY命令の使用が推奨される。


### EXPOSE
```
EXPOSE　<ポート番号>　[<ポート番号２>...]
```

EXPOSE命令は、命令と名付けられて入るものの、ドキュメントとしての役割が強い。コンテナがどのポートでリスんしているかを明示しており、他の開発者がコンテナのネットワーク設定を理解しやすくするために存在している。
そのため、EXPOSE命令自体はポートを公開するのではなく実際に公開するには、.ymlファイルで追加の設定が必要となる。


### ENTRYPOINT
```
シェル形式
ENTRYPOINT <command>
```

Dockerfile内でコンテナが起動された際に、最初に自動的に実行されるメインプロセスを指定するために使用される。EXEC形式も可。例として、
```
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
```
のように設定しておくと、コンテナの起動と同時に、entrypoint.shというスクリプトを実行することができる。



## プロジェクトの概要
このプロジェクトは、Dockerを使用して複数のサービスを仮想化し、小規模なインフラを設定するもであり、以下の要件に従い仮想マシン内で実行する。

### サービスの設定
- 各Dockerイメージは対応するサービスと同じ名前を持つ
- 各サービスは専用コンテナで実行される
- コンテナは最新安定版の一つ前のバージョンのAlpineまたはDebianからBuildされる
- 各サービスごとにDockerfileを作成し、Makefileを用いてdocker-compose.ymlで呼び出す
- Alpine, Debianを除き、DockerHubなどの既製のドッカーイメージの使用は禁止

### コンテナの設定
- NGINX TLSv1.2またはTLSv1.3のみをサポートするよう設定されたNGINXコンテナ
- WordPress NGINXを含まず、WordPressとphp-fpmをインストールして設定するコンテナ
- MaruaDB　NGINXを含まずにMairaDBをインストールしたコンテナ
- ボリューム
  - WordPressデータ用のボリューム
  - WordPressサイトファイル用のボリューム
- ネットワーク　コンテナ間通信を確立するためのdocker-network  

### その他の要件
- コンテナはクラッシュ時に再起動する必要がある
- 無限ループやtail -lといったコマンドは使用禁止
- WordPressデータベースには２人のユーザーが必要。一人は管理者。
- 管理者のユーザー名に、"admin"や"administrator"を含めてはいけない
- ホストマシンの/home/login/dataフォルダにボリュームを配置する
- ローカルIPアドレスにドメイン名を設定する。ドメイン名はlogin.42.fr（自分のログイン名）
- .envファイルを使用して環境変数を管理し、パスワードはDockerfile煮含めない
- NGINXコンテナはポート443のみを通じてインフラストラクチャにアクセスする唯一のエントリーポイントである
 start php-fpm service in the foreground to keep the container running
#フォアグラウンドで実行。バックグラウンドで実行しようとして、フォアグラウンドに実行するコマンドがないとセル自体が終了し、シェルが終了すると、コンテナのメインプロセスが終了したとみなされコンテナ自体が修了する。しかし、フォアグラウンドで実行されている場合は維持可能

│   ├── docker-compose.yml
│   ├── .env
│   └── requirements/
│       ├── mariadb/
│       │   ├── Dockerfile
│       │   └── ...
│       ├── nginx/
│       │   ├── Dockerfile
│       │   └── ...
│       ├── wordpress/
│       │   ├── Dockerfile
│       │   └── ...
│       └── bonus/
│           └── ...
```
![Screenshot from 2024-07-19 04-41-04](https://github.com/user-attachments/assets/a4240699-400d-40fd-a434-3c8ab402377a)



Compose 唯一のエントリーポイントは、ポート４４３とNGINXを経由した経路である。ここで、ポート４４３はHTTPS通信のための標準ポートであり、HTTPSは、HTTP通信上に、SSL/TLSプロトコルを使用することで、データの暗号化と、より安全な通信を実現している。

### TLSとは
TLS (Transport Layer Security)とは、インターネット上でデータを暗号化し、安全に通信するためのプロトコルで、クライアント-サーバー間の通信を保護する。主に、
- 暗号化：通信内容を暗号化し、第三者が内容を解読できないようにする
- データ完全性：データ送信中に、データが改ざんされていないことを保証する
- 認証：通信相手が正当であることを確認する

といった機能を提供している。SSLはTLSの前身プロトコルであり、これらを用いることで、より安全なHTTPS通信を可能にしている。


## その他

### DockerとDocker composeの仕組み
コンテナ化技術を利用してアプリケーションの開発、テスト、デプロイを効率化するための技術。
コンテナとは、アプリケーションとその依存関係を一緒にパッケージ化してどこでも一貫した動作を保証するための技術で、VMとは異なり、ホストOSのカーネルを共有しアプリケーションごとに分離されれた環境を提供してくれる。実行環境をパッケージ化したテンプレートをイメージとよび、それを実行することでコンテナが起動される。
ドッカーコンポーズは各コンテナをサービスと定義し、サービス間の通信を管理するためのネットワークやデータの永続化を管理するためのボリュームの定義などのサービスを復数同時に管理するためのツールとなっている。

### Docker Composeを使用するDocker imageと使用しないDocker imageの違い
DockerComposeを使用しない場合、基本的にはここのドッカーイメージを手動で管理することになり、単一のサービスやシンプルなアプリケーションといった、他のサービスを必要としない場合に用いられる。

DockerComposeを使用する場合は、復数のDockerImageをまとめて管理し、簡単にすべての起動、停止、接続が可能となる。

### VMと比較したDockerの利点
- 軽量性　ドッカーはホストOSのカーネルを共有し、アプリケーションとその依存関係のみをパッケージ化するので非常に軽量。
- 起動時間　カーネルの共有をしているため、OSの起動プロセスが不要で迅速な起動が可能
- リソース効率　ホストマシンのリソースを効率的に利用し、メモリやCPUの消費を抑えられる。
- 移植性　依存関係とアプリケーションをパッケージ化しているので、異なる環境間での移植が用意